<div class="row p-t-25">
  <!-- Filtres Section -->
  <div class="filter-section">
    <div class="row">
      <!-- Search Field -->
      <div class="col-md-4">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Rechercher une dette…</mat-label>
          <input matInput
                 placeholder="Rechercher par intitulé, montant..."
                 (keyup)="applyFilter($event.target.value)"
                 [value]="searchText" />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>

      <!-- Reset Button -->
      <div class="col-md-2">
        <button mat-stroked-button (click)="resetFilters()" class="w-100">
          <i class="ti ti-refresh m-r-8"></i>
          Réinitialiser
        </button>
      </div>

      <!-- Espace pour alignement -->
      <div class="col-md-6"></div>
    </div>
  </div>

  <div class="col-12">
    <app-card cardTitle="Mes Dettes" padding="0" cardClass="sm-block">

      <!-- Header Options avec actions globales -->
      <ng-template #headerOptionsTemplate>
        <div class="table-options">
          <!-- Payer toutes les dettes via wallet -->
          <button mat-flat-button color="primary"
                  (click)="payAllWalletDebts()"
                  [disabled]="isLoading || filteredDataSource.length === 0"
                  class="global-pay-button">
            <i class="ti ti-wallet m-r-8"></i>
            Tout payer via Wallet
          </button>
          <!-- solde de la carte -->
          <div class="card-balance-info" *ngIf="cardBalance !== null">
            Solde Carte: <strong>{{ formatAmount(cardBalance) }}</strong>
          </div>
        </div>
      </ng-template>

      <div class="p-b-15">
        <div class="table-container table-responsive">

          <!-- Chargement -->
          <div *ngIf="isLoading" class="loading-spinner text-center p-3">
            <mat-spinner diameter="50"></mat-spinner>
          </div>

          <!-- Tableau -->
          <table mat-table [dataSource]="filteredDataSource" class="mat-elevation-z8" *ngIf="!isLoading">

            <!-- Intitulé Column -->
            <ng-container matColumnDef="intitule">
              <th mat-header-cell *matHeaderCellDef class="p-l-25">INTITULÉ</th>
              <td mat-cell *matCellDef="let debt" class="p-l-25 text-nowrap">
                <div class="flex align-item-center">
                  <div class="flex-shrink-0">
                    <div class="avatar-circle" [style.background]="createStableAvatar(debt).color">
                      {{ createStableAvatar(debt).letter }}
                    </div>
                  </div>
                  <div class="flex-grow-1 m-l-15">
                    <div class="f-w-600">
                      {{ debt.intitule?.length > 10 ? (debt.intitule | slice:0:10) + '…' : debt.intitule }}
                    </div>
                    <div class="mat-caption text-muted">ID: {{ debt.id }}</div>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Montant Column -->
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef >MONTANT</th>
              <td mat-cell *matCellDef="let debt" class=" text-nowrap">
                <div class="amount-container">
                  <div class="f-w-600">{{ formatAmount(debt.amount) }}</div>
                  <div class="mat-caption" [style.color]="getAmountColor(debt.amount)">
                    {{ getAmountStatus(debt.amount) }}
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Card Column -->
            <ng-container matColumnDef="card">
              <th mat-header-cell *matHeaderCellDef class="text-center">CARTE</th>
              <td mat-cell *matCellDef="let debt" class="text-center text-nowrap">
                <div class="card-container">
                  <div class="f-w-600">{{ getCardInfo(debt) }}</div>
                  <div class="mat-caption text-muted">
                    <mat-chip class="status-chip" [style.background]="debt.card?.status === 'ACTIVE' ? '#4caf50' : '#ff9800'">
                      {{ debt.card?.status || 'N/A' }}
                    </mat-chip>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Solde Column -->
            <ng-container matColumnDef="balance">
              <th mat-header-cell *matHeaderCellDef >SOLDE</th>
              <td mat-cell *matCellDef="let debt" class=" text-nowrap">
                <div class="amount-container">
                  <div class="f-w-600">{{ formatAmount(debt.user.wallet.balance) }}</div>
                  <div class="mat-caption" [style.color]="getAmountColor(debt.user.wallet.balance)">
                    {{ getAmountStatus(debt.user.wallet.balance) }}
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Transactions Column -->
            <ng-container matColumnDef="transactions">
              <th mat-header-cell *matHeaderCellDef class="text-center">TRANSACTIONS</th>
              <td mat-cell *matCellDef="let debt" class="text-center text-nowrap">
                <div class="transactions-container">
                  <div *ngIf="hasTransactions(debt.id); else noTransactions">
                    <div *ngFor="let transaction of getTransactionsForDebt(debt.id); let i = index" class="transaction-item">
                      <div class="f-w-600">{{ i + 1 }}</div>
                      <div class="mat-caption text-muted">
                        {{ formatAmount(transaction.totalAmount) }} • {{ formatDate(transaction.createdAt) }}
                      </div>
                      <button mat-icon-button
                              color="primary"
                              (click)="viewTransactionDetails(transaction.transactionId)"
                              matTooltip="Voir les détails"
                              class="view-transaction-btn">
                        <i class="ti ti-eye f-16"></i>
                      </button>
                    </div>
                  </div>
                  <ng-template #noTransactions>
                    <div class="no-transactions">
                      <i class="ti ti-file-off"></i>
                      <span class="mat-caption text-muted">Aucune transaction</span>
                    </div>
                  </ng-template>
                </div>
              </td>
            </ng-container>

            <!-- Date de création Column -->
            <ng-container matColumnDef="createdAt">
              <th mat-header-cell *matHeaderCellDef>DATE</th>
              <td mat-cell *matCellDef="let debt" class="text-nowrap">
                <div class="date-container">
                  <div class="f-w-600">{{ formatDate(debt.createdAt) }}</div>
                  <div class="mat-caption text-muted">{{ getDaysAgo(debt.createdAt) }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Actions de paiement Column -->
            <ng-container matColumnDef="paymentActions">
              <th mat-header-cell *matHeaderCellDef class="text-center">ACTIONS</th>
              <td mat-cell *matCellDef="let debt" class="text-center text-nowrap">
                <div class="text-center text-nowrap">
                  <ul class="list-inline p-l-0">
                    <!-- Menu Paiement Carte -->
                    <li class="list-inline-item m-r-10"
                        [matMenuTriggerFor]="cardMenu"
                        matTooltip="Paiements par carte">
                      <a href="javascript:" class="avatar avatar-xs text-muted">
                        <i class="ti ti-credit-card f-18"></i>
                      </a>
                    </li>
                    <mat-menu #cardMenu="matMenu" class="payment-menu">
                      <button mat-menu-item (click)="payDebtWithCard(debt)">
                        <i class="ti ti-credit-card m-r-8"></i>
                        Payer total
                      </button>
                      <button mat-menu-item (click)="partialPayDebtWithCard(debt)">
                        <i class="ti ti-credit-card-off m-r-8"></i>
                        Payer partiel
                      </button>
                      <button mat-menu-item (click)="payAllCardDebts(debt.cardId)">
                        <i class="ti ti-credit-card-filled m-r-8"></i>
                        Tout payer carte
                      </button>
                    </mat-menu>

                    <!-- Menu Paiement Wallet -->
                    <li class="list-inline-item m-r-10"
                        [matMenuTriggerFor]="walletMenu"
                        matTooltip="Paiements par wallet">
                      <a href="javascript:" class="avatar avatar-xs text-muted">
                        <i class="ti ti-wallet f-18"></i>
                      </a>
                    </li>
                    <mat-menu #walletMenu="matMenu" class="payment-menu">
                      <button mat-menu-item (click)="payDebtWithWallet(debt)">
                        <i class="ti ti-wallet m-r-8"></i>
                        Payer total
                      </button>
                      <button mat-menu-item (click)="partialPayDebtWithWallet(debt)">
                        <i class="ti ti-wallet-off m-r-8"></i>
                        Payer partiel
                      </button>
                    </mat-menu>

                    <!-- Suppression -->
                    <li class="list-inline-item m-r-10"
                        matTooltip="Supprimer la dette">
                      <a href="javascript:"
                         (click)="deleteDebt(debt)"
                         class="avatar avatar-xs text-muted">
                        <i class="ti ti-trash f-18"></i>
                      </a>
                    </li>
                  </ul>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

            <!-- Aucune donnée -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="7">
                <div *ngIf="!isLoading" class="text-center p-3 no-data">
                  <i class="ti ti-report-money no-data-icon"></i>
                  <p class="no-data-text">
                    {{ searchText ? 'Aucune dette trouvée pour "' + searchText + '"' : 'Aucune dette enregistrée' }}
                  </p>
                  <p class="no-data-subtext" *ngIf="!searchText">
                    Vous n'avez aucune dette en attente de paiement.
                  </p>
                </div>
              </td>
            </tr>
          </table>

        </div>
      </div>
    </app-card>
  </div>
</div>
